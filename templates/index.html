<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Enhanced RAG Engine</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/tippy.js/6.3.7/tippy.min.css">
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://unpkg.com/tippy.js@6"></script>
        <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .markdown-body pre {
            background-color: #f6f8fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin: 1rem 0;
        }
        .markdown-body code {
            font-family: monospace;
            background-color: #f6f8fa;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
        }
    </style>
    </head>
    <body class="bg-gray-100 min-h-screen">
        <div class="container mx-auto px-4 py-6">
            <h1
                class="text-3xl font-bold text-center text-blue-600 mb-8">Enhanced
                RAG Engine</h1>

            <!-- Query Section -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <div class="relative">
                    <textarea id="queryInput"
                        class="w-full border border-gray-300 p-4 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        rows="4"
                        placeholder="Enter your question here..."
                        data-tippy-content="Enter your DSA-related question here"></textarea>
                    <button id="submitQuery"
                        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <span>Submit</span>
                        <div class="loader hidden"></div>
                    </button>
                </div>
            </div>

            <!-- Response Section -->
            <div id="responseSection" class="mt-8 hidden">
                <div class="bg-white shadow-lg rounded-lg p-6">
                    <h2
                        class="text-2xl font-semibold text-green-600 mb-4">Response</h2>
                    <div id="streamingResponse"
                        class="markdown-body prose max-w-none"></div>

                    <!-- Metadata Section -->
                    <div class="mt-6 border-t pt-4">
                        <h3
                            class="text-lg font-semibold text-gray-700 mb-4">Analysis
                            Metadata</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Confidence Score -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4
                                    class="text-sm font-medium text-gray-600 mb-2">Confidence
                                    Score</h4>
                                <canvas id="confidenceChart" width="200"
                                    height="100"></canvas>
                            </div>
                            <!-- Patterns -->
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4
                                    class="text-sm font-medium text-gray-600 mb-2">Identified
                                    Patterns</h4>
                                <div id="patternsList" class="space-y-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Initialize tooltips
        tippy('[data-tippy-content]');

        // Markdown configuration
        marked.setOptions({
            highlight: function(code, lang) {
                return code;
            }
        });

        let confidenceChart = null;

        function updateConfidenceChart(confidence) {
            if (confidenceChart) {
                confidenceChart.destroy();
            }

            const ctx = document.getElementById('confidenceChart').getContext('2d');
            confidenceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Confidence', 'Remaining'],
                    datasets: [{
                        data: [confidence * 100, (1 - confidence) * 100],
                        backgroundColor: ['#4CAF50', '#f0f0f0']
                    }]
                },
                options: {
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updatePatternsList(patterns) {
            const patternsDiv = document.getElementById('patternsList');
            patternsDiv.innerHTML = patterns.map(pattern => 
                `<div class="bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block mr-2 mb-2">${pattern}</div>`
            ).join('');
        }

        let controller = null;
        document.getElementById("submitQuery").addEventListener("click", async () => {
            const userInput = document.getElementById("queryInput").value;
            if (!userInput) {
                alert("Please enter a question.");
                return;
            }

            // Cancel previous request if exists
            if (controller) {
                controller.abort();
            }
            controller = new AbortController();

            const responseSection = document.getElementById("responseSection");
            const streamingResponse = document.getElementById("streamingResponse");
            const submitButton = document.getElementById("submitQuery");
            const loader = submitButton.querySelector(".loader");

            // Show loading state
            submitButton.disabled = true;
            loader.classList.remove("hidden");
            streamingResponse.innerHTML = '';
            responseSection.classList.remove("hidden");

            try {
                const response = await fetch("/stream", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ user_input: userInput }),
                    signal: controller.signal
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const {value, done} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    
                    // Check for complete JSON objects
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // Keep the incomplete line in the buffer
                    
                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            if (data.type === 'token') {
                                streamingResponse.innerHTML = marked.parse(data.content);
                            } else if (data.type === 'metadata') {
                                updateConfidenceChart(data.metadata.average_confidence);
                                updatePatternsList(data.metadata.pattern_types);
                            }
                        } catch (e) {
                            console.error('Error parsing JSON:', e);
                        }
                    }
                }
            } catch (err) {
                if (err.name === 'AbortError') {
                    console.log('Request aborted');
                } else {
                    console.error('Error:', err);
                    alert("Error fetching response.");
                }
            } finally {
                submitButton.disabled = false;
                loader.classList.add("hidden");
                controller = null;
            }
        });
    </script>
    </body>
</html>
--version 1.0.1