<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>RAG Chatbot</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <style>
        .dark {
            color-scheme: dark;
        }
        
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to {transform: rotate(360deg);}
        }

        .code-block {
            background: #24292e;
            border-radius: 0.5rem;
            margin: 1rem 0;
            position: relative;
        }

        .code-block pre {
            margin: 0;
            padding: 1rem;
            overflow-x: auto;
        }

        .code-block code {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1d23;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
    </head>
    <body
        class="bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-200">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <div class="w-80 bg-gray-800 text-white p-4 flex flex-col">
                <h2 class="text-xl font-semibold mb-4">Chat History</h2>
                <div id="historyContent"
                    class="flex-1 overflow-y-auto space-y-4">
                    <!-- History items will be inserted here -->
                </div>
                <button id="clearHistory"
                    class="mt-4 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                    Clear History
                </button>
            </div>

            <!-- Main Content -->
            <div class="flex-1 flex flex-col">
                <!-- Header -->
                <header class="bg-white dark:bg-gray-800 shadow-sm p-4">
                    <div
                        class="max-w-5xl mx-auto flex justify-between items-center">
                        <h1
                            class="text-3xl font-bold text-center text-gray-800 dark:text-gray-100">RAG
                            Chatbot</h1>
                        <button id="themeToggle"
                            class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                            <svg class="w-6 h-6 dark:hidden" fill="currentColor"
                                viewBox="0 0 20 20">
                                <path
                                    d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                            </svg>
                            <svg
                                class="w-6 h-6 hidden dark:block text-yellow-500"
                                fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"></path>
                            </svg>
                        </button>
                    </div>
                </header>

                <!-- Chat Container -->
                <div class="flex-1 overflow-hidden">
                    <div class="max-w-5xl mx-auto p-4 h-full flex flex-col">
                        <!-- Messages container -->
                        <div id="messages"
                            class="flex-1 overflow-y-auto space-y-4 mb-4">
                            <!-- Messages will be inserted here -->
                        </div>

                        <!-- Input form -->
                        <form id="queryForm" class="flex gap-2">
                            <input
                                type="text"
                                id="queryInput"
                                class="flex-1 px-4 py-3 rounded-lg border dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"
                                placeholder="Type your question...">
                            <button
                                type="submit"
                                class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 flex items-center gap-2">
                                <span>Send</span>
                                <div class="loader hidden"></div>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <script>
        // Theme toggle
        const theme = {
            init() {
                if (localStorage.theme === 'dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    document.documentElement.classList.add('dark');
                }
                
                document.getElementById('themeToggle').addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                });
            }
        };

        // Chat functionality
        const chat = {
            messages: document.getElementById('messages'),
            form: document.getElementById('queryForm'),
            input: document.getElementById('queryInput'),
            loader: document.querySelector('.loader'),
            controller: null,

            init() {
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });
                
                // Clear history button
                document.getElementById('clearHistory').addEventListener('click', async () => {
                    try {
                        await fetch('/clear_history', { method: 'POST' });
                        document.getElementById('historyContent').innerHTML = '';
                        this.messages.innerHTML = '';
                    } catch (error) {
                        console.error('Error clearing history:', error);
                    }
                });
            },

            async loadHistory() {
                try {
                    const response = await fetch('/history');
                    const data = await response.json();
                    document.getElementById('historyContent').innerHTML = data.reverse().map(item => `
                        <div class="border-b border-gray-700 pb-2">
                            <p class="text-sm text-gray-400">${item.user_input}</p>
                            <p class="text-sm text-gray-300">${item.model_response.substring(0, 100)}...</p>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading history:', error);
                }
            },

            async sendMessage() {
                const userInput = this.input.value.trim();
                if (!userInput) return;

                // Add user message
                this.addMessage('user', userInput);
                this.input.value = '';

                // Show loader
                const submitButton = this.form.querySelector('button');
                submitButton.disabled = true;
                this.loader.classList.remove('hidden');

                // Cancel previous request if exists
                if (this.controller) {
                    this.controller.abort();
                }
                this.controller = new AbortController();

                try {
                    const response = await fetch("/stream", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ user_input: userInput }),
                        signal: this.controller.signal
                    });

                    const botMessage = this.addMessage('bot', '');
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const {value, done} = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, {stream: true});
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            try {
                                const data = JSON.parse(line);
                                if (data.type === 'token') {
                                    this.updateBotMessage(botMessage, data.content);
                                } else if (data.type === 'metadata') {
                                    // Handle metadata if needed
                                }
                            } catch (e) {
                                console.error('Error parsing JSON:', e);
                            }
                        }
                    }

                    // Refresh history after message
                    this.loadHistory();

                    // Highlight code blocks after complete response
                    hljs.highlightAll();

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('Error:', error);
                    }
                } finally {
                    submitButton.disabled = false;
                    this.loader.classList.add('hidden');
                    this.controller = null;
                }
            },

            addMessage(type, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const bubble = document.createElement('div');
                bubble.className = type === 'user' 
                    ? 'bg-blue-500 text-white rounded-lg px-4 py-2 max-w-[80%]'
                    : 'bg-gray-100 dark:bg-gray-700 rounded-lg px-4 py-2 max-w-[80%]';
                
                if (type === 'bot') {
                    bubble.innerHTML = `<div class="message-content"></div>`;
                } else {
                    bubble.textContent = content;
                }

                messageDiv.appendChild(bubble);
                this.messages.appendChild(messageDiv);
                this.messages.scrollTop = this.messages.scrollHeight;
                return bubble;
            },

            updateBotMessage(messageElement, content) {
                const contentDiv = messageElement.querySelector('.message-content');
                let formattedContent = content;

                // Format code blocks with syntax highlighting
                formattedContent = formattedContent.replace(
                    /```(\w+)?\n([\s\S]*?)```/g,
                    (_, lang, code) => `<div class="code-block"><pre><code class="language-${lang || 'plaintext'}">${code.trim()}</code></pre></div>`
                );

                contentDiv.innerHTML = formattedContent;
                this.messages.scrollTop = this.messages.scrollHeight;
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            theme.init();
            chat.init();
            chat.loadHistory();
        });
    </script>
    </body>
</html>
<!-- Normal Chatbot type of interface -->